name: Update Eclipse p2 (URL + repository id + version)

on:
  schedule:
    - cron: "30 17 * * 0"   # Runs at 17:30 UTC, every Sunday
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  POM_PATH: pom.xml   # optional: limit URL/id updates to a specific POM (versions still updated repo-wide via update-version.sh)

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run updater
        id: updater
        run: ./update-eclipse-p2.sh "${POM_PATH}"

      - name: Create Pull Request
        if: steps.updater.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Eclipse SimRel to ${{ steps.updater.outputs.latest }} (p2 URL + repo id + version ${{ steps.updater.outputs.new_version }})"
          title: "Update Eclipse SimRel to ${{ steps.updater.outputs.latest }}"
          body: |
            - **p2 URL/id:** `${{ steps.updater.outputs.new_url }}` / `eclipse-${{ steps.updater.outputs.latest }}`
            - **version:** `${{ steps.updater.outputs.new_version }}`
          branch: ${{ steps.updater.outputs.branch }}
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
