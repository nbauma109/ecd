name: Update Eclipse p2 (URL + version)

on:
  schedule:
    - cron: "7 5 * * *"   # daily
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  POM_PATH: pom.xml

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find latest Eclipse SimRel and update pom.xml
        id: do_update
        shell: bash
        run: |
          set -euo pipefail

          POM="$POM_PATH"
          [[ -f "$POM" ]] || { echo "Cannot find $POM" >&2; exit 1; }

          # Find latest directory like 2025-09 from the Eclipse releases index
          latest="$(curl -sL https://download.eclipse.org/releases/ \
            | grep -Eo 'href="[0-9]{4}-[0-9]{2}/"' \
            | sed -E 's/^href="([0-9]{4}-[0-9]{2})\/"$/\1/' \
            | sort -u | sort -r | head -n1)"

          [[ -n "${latest:-}" ]] || { echo "Could not determine latest Eclipse release." >&2; exit 1; }

          latest_url="https://download.eclipse.org/releases/${latest}/"
          y="${latest%-*}"
          m="${latest#*-}"
          new_version="${y}.${m}.0"

          echo "Latest: $latest"
          echo "New URL: $latest_url"
          echo "New version: $new_version"

          changed=0

          # 1) Update p2 URL everywhere (safe to do)
          current_url="$(grep -Eo 'https://download\.eclipse\.org/releases/[0-9]{4}-[0-9]{2}/' "$POM" | head -n1 || true)"
          if [[ "${current_url:-}" != "$latest_url" ]]; then
            esc_url="$(printf '%s' "$latest_url" | sed 's/[\/&]/\\&/g')"
            sed -i -E "s#https://download\.eclipse\.org/releases/[0-9]{4}-[0-9]{2}/#${esc_url}#g" "$POM"
            echo "Updated p2 URL -> $latest_url"
            changed=1
          fi

          # 2) Update ONLY the first <version>YYYY.MM.X</version> to YYYY.MM.0
          current_ver="$(grep -Eo '<version>[0-9]{4}\.[0-9]{2}\.[0-9]+</version>' "$POM" | head -n1 | sed -E 's#</?version>##g' || true)"
          if [[ -z "${current_ver:-}" ]]; then
            echo "No matching YYYY.MM.X <version> found in $POM (skipping version bump)."
          elif [[ "$current_ver" != "$new_version" ]]; then
            # Replace only the first occurrence using GNU sed's 0,/<pattern>/ range
            sed -i -E "0,/<version>[0-9]{4}\.[0-9]{2}\.[0-9]+<\/version>/{s//<version>${new_version}<\/version>/}" "$POM"
            echo "Updated project version -> $new_version"
            changed=1
          else
            echo "Version already up to date."
          fi

          if [[ $changed -eq 1 ]]; then
            {
              echo "changed=true"
              echo "branch=update-eclipse-${latest}"
              echo "latest=${latest}"
              echo "new_url=${latest_url}"
              echo "new_version=${new_version}"
            } >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes necessary."
          fi

      - name: Create Pull Request
        if: steps.do_update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Eclipse SimRel to ${{ steps.do_update.outputs.latest }} (p2 URL + version ${{ steps.do_update.outputs.new_version }})"
          title: "Update Eclipse SimRel to ${{ steps.do_update.outputs.latest }}"
          body: |
            - **p2 URL:** `${{ steps.do_update.outputs.new_url }}`
            - **version:** `${{ steps.do_update.outputs.new_version }}`
          branch: ${{ steps.do_update.outputs.branch }}
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
