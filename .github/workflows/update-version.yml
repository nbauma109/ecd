name: "Increment version"

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**/README.md'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**/README.md'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Create .ssh directory
      run: mkdir $HOME/.ssh
    - name: Create known hosts file
      run: echo "${{ secrets.KNOWN_HOSTS }}" > $HOME/.ssh/known_hosts
    - name: Create private key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/.ssh/id_ed25519
        chmod 400 $HOME/.ssh/id_ed25519
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Setup git user
      run: |
         git config --global user.email "nbauma109@github.com"
         git config --global user.name "nbauma109"
    - name: Update Version
      run: |
         export VERSION=`grep Bundle-Version org.sf.feeling.decompiler/META-INF/MANIFEST.MF | cut -d: -f2 | xargs`
         export MAJOR=`echo $VERSION | cut -d. -f1`
         export MINOR=`echo $VERSION | cut -d. -f2`
         export PATCH=`echo $VERSION | cut -d. -f3`
         export NEW_PATCH=`expr $PATCH + 1`
         export NEW_VERSION=$MAJOR.$MINOR.$NEW_PATCH
         chmod u+x ./update-version.sh
         ./update-version.sh $NEW_VERSION
         git commit -a -m "[update version] $VERSION -> $NEW_VERSION"
         git push
       